<script lang="ts">
	import useStyles from './Input.styles';
	import { createEventForwarder, useActions } from '$lib/internal';
	import { get_current_component } from 'svelte/internal';
	import Box from '../Box/Box.svelte';
	import type { InputProps as $$InputProps } from './Input.styles';

	export let use: $$InputProps['use'] = [],
		element: $$InputProps['element'] = undefined,
		className: $$InputProps['className'] = '',
		override: $$InputProps['override'] = {},
		root: $$InputProps['root'] = 'input',
		icon: $$InputProps['icon'] = null,
		iconWidth: $$InputProps['iconWidth'] = 36,
		iconProps: $$InputProps['iconProps'] = { size: 20, color: 'currentColor' },
		showRightSection: $$InputProps['showRightSection'] = $$slots.rightSection,
		rightSectionWidth: $$InputProps['rightSectionWidth'] = 36,
		rightSectionProps: $$InputProps['rightSectionProps'] = {},
		wrapperProps: $$InputProps['wrapperProps'] = {},
		id: $$InputProps['id'] = 'input-id',
		required: $$InputProps['required'] = false,
		radius: $$InputProps['radius'] = 'sm',
		variant: $$InputProps['variant'] = 'default',
		disabled: $$InputProps['disabled'] = false,
		size: $$InputProps['size'] = 'sm',
		value: $$InputProps['value'] = '',
		invalid: $$InputProps['invalid'] = false,
		multiline: $$InputProps['multiline'] = false;
	export { className as class };

	/** An action that forwards inner dom node events from parent component */
	const forwardEvents = createEventForwarder(get_current_component());

	/** workaround for root type errors, this should be replaced by a better type system */
	const castRoot = () => root as string;
	let isHTMLElement;
	let isComponent;

	function onChange() {
		// the 'this' keyword in this case is the
		// HTML element provided in prop 'root'
		value = this.value;
	}

	$: {
		isHTMLElement = root && typeof root === 'string';
		isComponent = root && typeof root === 'function';
	}
	$: ({ cx, classes, getStyles } = useStyles({
		icon,
		iconWidth,
		invalid,
		multiline,
		radius,
		rightSectionWidth,
		showRightSection,
		size,
		variant
	}));
</script>

<!--
@component
**DISCLAIMER: In most cases, you should not use Input component in your application. Input component is a base for other inputs and was not designed to be used directly.**

Base component to create custom inputs
	
@see https://svelteui.org/core/input
@example
    ```svelte
    <Input
      icon={Twitter}
      placeholder="Your twitter"
      rightSectionWidth={70}
      override={{ '& .rightSection': { pointerEvents: 'none' } }}
    >
		<Badge slot='rightSection' color="blue" variant="filled">
			new
		</Badge>
	<Input />
    ```
-->

<Box {...wrapperProps} class={getStyles({ css: override })} {...$$restProps}>
	{#if icon}
		<svelte:component
			this={icon}
			size={iconProps.size}
			color={iconProps.color}
			class={classes.icon}
		/>
	{/if}
	{#if isHTMLElement && root === 'input'}
		<input
			bind:value
			bind:this={element}
			use:useActions={use}
			use:forwardEvents
			{required}
			{disabled}
			{id}
			aria-invalid={invalid}
			class:disabled
			class:invalid
			class:withIcon={icon}
			class={cx(className, classes.input, `${variant}Variant`)}
			{...$$restProps}
		/>
	{:else if isHTMLElement}
		<!-- prettier-ignore -->
		<svelte:element
			bind:this={element}
			this={castRoot()}
			value={value}
			use:useActions={use}
			use:forwardEvents
			on:change={onChange}
			{required}
			{disabled}
			{id}
			aria-invalid={invalid}
			class:disabled
			class:invalid
			class:withIcon={icon}
			class={cx(className, classes.input, `${variant}Variant`)}
			{...$$restProps}
			>
			<slot />
		</svelte:element>
	{:else if isComponent}
		<svelte:component
			this={root}
			bind:element
			bind:value
			use={[forwardEvents, [useActions, use]]}
			aria-invalid={invalid}
			class={cx(
				className,
				{
					[classes.disabled]: disabled,
					[classes.invalid]: invalid,
					[classes.withIcon]: icon
				},
				`${variant}Variant`
			)}
			{disabled}
			{required}
			{id}
			{...$$restProps}
		>
			<slot />
		</svelte:component>
	{/if}
	{#if showRightSection}
		<div {...rightSectionProps} class={classes.rightSection}>
			<slot name="rightSection" />
		</div>
	{/if}
</Box>
